var fg2D;var bg2D;var fgCan;var bgCan;var scl=15;const EARTH=-2;const VOID=-1;const STAR=0;const PLYR=1;const MOON=2;const OBST=3;const ALIEN=4;const LASER=5;const keyState={};const MOVE_LEFT=37;const MOVE_UP=38;const MOVE_RIGHT=39;const MOVE_DOWN=40;const KEY_RESET=82;var lastKeyCode=0;var gameOver=0;var jumpUp=0;var resetJump=0;var bgInterval;var gameLoopInterval;var renderInterval;var obstacleInterval;var canJump=true;var jumpReturn=false;var seenEarth=false;var laserDelay=15;var playerBase=0;function startMovement(){if(keyState[MOVE_RIGHT]||keyState[MOVE_LEFT]){var b=astronaut.posX;var a=astronaut.posY;astronaut.posX+=(keyState[MOVE_RIGHT]&&astronaut.posX<foreground.x)?1:0;astronaut.posX-=(keyState[MOVE_LEFT]&&astronaut.posX>0)?1:0;if(foreground.map[[b,a]]!=OBST){foreground.map[[b,a]]=VOID}else{foreground.map[[astronaut.posX,a]]=OBST}}if(keyState[MOVE_UP]&&astronaut.posY==playerBase&&canJump){jumpUp=1;canJump=false}}document.onkeydown=function(a){if(a.keyCode==KEY_RESET){init();return}keyState[a.keyCode||a.which]=true};document.onkeyup=function(a){keyState[a.keyCode||a.which]=false;if(a.keyCode==MOVE_UP){canJump=true}};var foreground={x:Math.floor(640/scl),y:Math.floor(360/scl)-1,map:[[]],initMap:function(){for(var a=0;a<=foreground.x;a++){for(var b=0;b<=foreground.y;b++){if(b>foreground.y-2){foreground.map[[a,b]]=MOON;continue}foreground.map[[a,b]]=VOID}}},renderMap:function(){if(jumpUp&&astronaut.posY<=(playerBase-6)){jumpUp=0;resetJump=1}else{if(resetJump&&astronaut.posY>=playerBase){astronaut.posY=playerBase;resetJump=0}}var e=astronaut.posX;var c=astronaut.posY;laserDelay-=1;if(laserDelay==0){laserDelay=5}gameOver=(foreground.map[[e,c]]==OBST)||(foreground.map[[e,c]]==LASER);astronaut.posY=astronaut.posY-(jumpReturn?jumpUp:0)+(jumpReturn?resetJump:0);jumpReturn=!jumpReturn;if(!gameOver){gameOver=(foreground.map[[e,astronaut.posY]]==OBST)||(foreground.map[[e,astronaut.posY]]==LASER)}foreground.map[[e,c]]=VOID;foreground.map[[astronaut.posX,astronaut.posY]]=PLYR;fg2D.font="15px Lucida Console, Monaco, monospace";for(var a=0;a<=foreground.x;a++){var b=false;for(var d=0;d<=foreground.y;d++){switch(foreground.map[[a,d]]){case MOON:fg2D.fillStyle=gameOver?"red":"#888888";fg2D.fillText("#",a*scl+5,d*scl+10);break;case PLYR:fg2D.fillStyle=gameOver?"red":"white";fg2D.fillText("@",a*scl+5,d*scl+10);break;case OBST:if(gameOver){foreground.map[[a,d]]=VOID;break}fg2D.fillStyle="red";fg2D.fillText("n",a*scl+5,d*scl+10);if(a!=-1){foreground.map[[a-1,d]]=foreground.map[[a,d]];foreground.map[[a,d]]=VOID}break;case LASER:if(b){continue}b=true;if(gameOver){foreground.map[[a,d]]=VOID;break}fg2D.fillStyle="cyan";fg2D.fillText("|",a*scl+5,d*scl+10);if(d!=foreground.y-2){foreground.map[[a,d+1]]=foreground.map[[a,d]];b=true;foreground.map[[a,d]]=VOID}else{foreground.map[[a,d]]=VOID}break;case ALIEN:if(gameOver){foreground.map[[a,d]]=VOID;break}fg2D.fillStyle="green";fg2D.fillText("V",a*scl+5,d*scl+10);if(a!=-1){foreground.map[[a-1,d]]=foreground.map[[a,d]];if(laserDelay==5){foreground.map[[a,d+1]]=LASER}foreground.map[[a,d]]=VOID}break;default:fg2D.fillStyle="black";fg2D.fillText(" ",a*scl+5,d*scl+10);break}}}}};var astronaut={posX:0,posY:0};window.onload=function(){fgCan=document.getElementById("fg");fg2D=fgCan.getContext("2d");bgCan=document.getElementById("bg");bg2D=bgCan.getContext("2d");init()};function init(){playerBase=foreground.y-2;gameOver=0;astronaut.posX=0;astronaut.posY=playerBase;bgMap.initMap();foreground.initMap();update();gameLoopInterval=setInterval(startMovement,50);renderInterval=setInterval(update,50);shiftBackground();addObstacle()}function update(){if(gameOver){clearInterval(bgInterval);clearInterval(renderInterval);clearInterval(gameLoopInterval);return}render()}function render(){bg2D.fillStyle="black";bg2D.fillRect(0,0,bgCan.width,bgCan.height);clearInterval(bgInterval);fg2D.clearRect(0,0,fgCan.width,fgCan.height);foreground.renderMap();bgMap.renderMap()}function addObstacle(){if(Math.random()>0.5){foreground.map[[foreground.x,Math.floor(foreground.y/2)]]=ALIEN}else{for(var a=foreground.y-(3+Math.ceil(Math.random()*2));a<=foreground.y-2;a++){foreground.map[[foreground.x,a]]=OBST}}setTimeout(addObstacle,Math.random()*2000)};